# 模拟测试指南

> **注意**：本文档为内部开发文档，基准测试脚本已移至内部开发工具，不对外提供。  
> 如需了解测试结果，请查看 [docs/EXPERIMENT_SUMMARY.md](EXPERIMENT_SUMMARY.md)

> 本文档说明我们如何创建简单的 Agent 来模拟用户使用 RAGEnhancedAgentMemory 插件优化自己的 Agent，验证插件的易用性和生产环境效果

## 📋 测试目的

本测试旨在验证：

1. **插件易用性**：我们能否轻松将插件集成到自己的 Agent 中进行优化（模拟用户使用场景）
2. **生产环境效果**：插件在实际使用场景下的性能表现
3. **功能完整性**：长期记忆、存储优化、信息保留等功能是否正常工作

## 🎯 测试方法

我们创建了一个简单的 Agent（模拟用户已有的 Agent），然后使用以下两种方式测试：

1. **增强版**：使用 RAGEnhancedAgentMemory 插件优化 Agent
2. **基线版**：使用简单的滑动窗口（不使用插件，保持原始状态）

通过对比两者的表现，验证插件的优化效果。

## 📋 测试脚本说明

### 1. 增强版测试（使用插件优化）

**脚本**: `scripts/benchmark/auto_player.py`

**特点**:
- ✅ 使用 RAGEnhancedAgentMemory 插件优化 Agent
- ✅ 分层记忆系统（瞬时、短期、长期）
- ✅ 语义检索和去重
- ✅ 存储优化（低价值过滤）
- ✅ 长期记忆召回能力

### 2. 基线版测试（原始 Agent，未优化）

**脚本**: `scripts/benchmark/baseline_auto_player.py`

**特点**:
- ❌ 不使用 RAGEnhancedAgentMemory 插件（保持原始状态）
- ❌ 仅使用简单滑动窗口（默认10轮）
- ❌ 无语义检索
- ❌ 无存储优化
- ❌ 无长期记忆（超出窗口的信息丢失）

### 3. 对比测试（推荐）

**脚本**: `scripts/benchmark/compare_test.py`

**功能**:
- 自动运行增强版和基线版
- 生成对比报告
- 展示性能差异和召回能力差异

## 🚀 使用方法

### 方式一：运行对比测试（推荐）

```bash
# 设置 API 密钥
export DEEPSEEK_API_KEY="your-api-key-here"

# 运行对比测试（同时运行增强版和基线版）
python scripts/benchmark/compare_test.py

# 或通过参数传递
python scripts/benchmark/compare_test.py --api-key "your-api-key-here"
```

### 方式二：分别运行

```bash
# 1. 运行增强版
python scripts/benchmark/auto_player.py --api-key "your-api-key-here"

# 2. 运行基线版
python scripts/benchmark/baseline_auto_player.py --api-key "your-api-key-here"
```

### 方式三：只运行其中一个

```bash
# 只运行增强版
python scripts/benchmark/compare_test.py --enhanced-only --api-key "your-api-key-here"

# 只运行基线版
python scripts/benchmark/compare_test.py --baseline-only --api-key "your-api-key-here"
```

## 📊 对比维度

### 1. 推理性能

| 指标 | 说明 |
|------|------|
| 平均延迟 | 单次请求的平均响应时间 |
| P95 延迟 | 95% 请求的延迟水平 |
| 首字延迟 (TTFT) | 从请求到第一个 token 的时间 |
| 总耗时 | 处理 100 轮对话的总时间 |

### 2. 存储效率

| 指标 | 增强版 | 基线版 |
|------|--------|--------|
| 存储优化 | ✅ 语义去重、低价值过滤 | ❌ 无优化 |
| 信息保留 | ✅ 长期记忆保留所有关键信息 | ❌ 仅保留窗口内信息 |
| 噪音过滤率 | ✅ 57-100% | ❌ 0% |

### 3. 长期记忆召回能力

| 测试项 | 增强版 | 基线版 | 说明 |
|--------|--------|--------|------|
| 工号（第1轮） | ✅ 可召回 | ❌ 无法召回 | 超出窗口 |
| 咖啡习惯（第2轮） | ✅ 可召回 | ❌ 无法召回 | 超出窗口 |
| 订单号（第6-35轮） | ✅ 可召回 | ⚠️ 可能召回 | 取决于窗口大小 |

## 📊 实际测试结果

### 模拟测试验证结果

| 验证项 | 结果 | 说明 |
|--------|------|------|
| **插件易用性** | ✅ 通过 | 我们可以轻松将插件集成到自己的 Agent 中进行优化（模拟用户场景） |
| **长期记忆召回** | ✅ 100.0% | 两种部署模式下都达到 100% 召回率 |
| **存储优化** | ✅ 60.4%-73.6% | 噪音过滤率显著，有效减少存储冗余 |
| **信息保留** | ✅ 100.0% | 关键信息得到有效保留 |
| **推理性能** | ✅ 提升 80.2% | 本地 vLLM 模式下吞吐量提升 80.2% |

> 📋 **详细测试报告**：参见 [模拟测试报告](EXPERIMENT_SUMMARY.md)

## 📈 预期结果

### 增强版优势

1. **长期记忆召回能力**
   - 召回成功率：**66.67%-100%**
   - 能够从长期记忆中召回早期（第1-5轮）的关键信息
   - 基线版：**0-33%**（仅能召回窗口内的信息）

2. **存储效率**
   - 噪音过滤率：**57-100%**
   - 语义去重：避免重复存储相似内容
   - 基线版：无优化，所有对话都保存在窗口内

3. **推理性能**
   - 延迟可能略高（因为需要检索），但换取长期记忆能力
   - 首字延迟：取决于 LLM API 性能

### 基线版限制

1. **信息丢失**
   - 超出窗口的对话完全丢失
   - 无法回答关于早期信息的问题

2. **无优化**
   - 所有对话都保存在窗口内
   - 无去重、无过滤

3. **无法处理长期依赖**
   - 用户在第5轮说"我喜欢Python"
   - 第50轮问"我之前说过喜欢什么编程语言？"
   - **系统完全无法回答**

## 📝 对比报告示例

运行对比测试后，会生成如下报告：

```
📊 增强版 vs 基线版 对比报告
============================================================

⚡ 推理性能对比
┌─────────────────────┬──────────────┬──────────────┬──────────┐
│ 指标                │ 增强版        │ 基线版        │ 差异      │
├─────────────────────┼──────────────┼──────────────┼──────────┤
│ 平均延迟            │ 1234.5 ms    │ 1100.2 ms    │ +12.2%   │
│ 平均首字延迟 (TTFT) │ 245.3 ms     │ 230.1 ms     │ +6.6%    │
└─────────────────────┴──────────────┴──────────────┴──────────┘

🧠 长期记忆召回能力对比
┌──────────┬──────────┬──────────┬──────────┐
│ 测试项   │ 增强版    │ 基线版    │ 改进     │
├──────────┼──────────┼──────────┼──────────┤
│ 工号     │ ✅       │ ❌       │ ✅ 提升  │
│ 咖啡习惯 │ ✅       │ ❌       │ ✅ 提升  │
│ 订单号   │ ✅       │ ⚠️       │ ✅ 提升  │
├──────────┼──────────┼──────────┼──────────┤
│ 召回成功率│ 100.0%  │ 33.3%    │ +66.7 百分点│
└──────────┴──────────┴──────────┴──────────┘

📝 对比结论
✅ 长期记忆召回能力显著提升：66.7 百分点
   • 增强版：100.0% (3/3)
   • 基线版：33.3% (1/3)
```

## 🔍 测试场景

两个版本使用**完全相同的测试脚本**（100轮对话）：

1. **Phase 1 (1-5轮)**: 设定人设
   - 工号：9527
   - 咖啡习惯：冰美式，不加糖

2. **Phase 2 (6-35轮)**: 重复查询订单
   - 订单号：ORDER_2026_001

3. **Phase 3 (36-85轮)**: 低价值灌水
   - 50轮无意义寒暄

4. **Phase 4 (86-100轮)**: 记忆突击检查
   - 测试是否能召回早期信息

## 💡 关键发现

### 增强版能够：
- ✅ 从长期记忆中召回第1轮提到的工号
- ✅ 从长期记忆中召回第2轮提到的咖啡习惯
- ✅ 从长期记忆中召回第6-35轮提到的订单号
- ✅ 过滤掉大部分低价值信息（50轮灌水）

### 基线版无法：
- ❌ 召回第1轮的工号（已超出窗口）
- ❌ 召回第2轮的咖啡习惯（已超出窗口）
- ⚠️ 可能召回订单号（如果在窗口内）

## 📚 相关文档

- [项目状态报告](PROJECT_STATUS.md) - 详细的性能指标
- [基线系统分析](BASELINE_ANALYSIS.md) - 传统方案的局限性
- [性能指标汇总](Performance.md) - 核心性能数据
