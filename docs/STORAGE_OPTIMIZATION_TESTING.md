# å­˜å‚¨æ•ˆç‡ä¼˜åŒ–æµ‹è¯•æ¡†æ¶

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†å­˜å‚¨æ•ˆç‡ä¼˜åŒ–çš„å®Œæ•´æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºéªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š
1. **è¯­ä¹‰å»é‡ä¸ä½ä»·å€¼è¿‡æ»¤** - éªŒè¯å­˜å‚¨é™ä½ 45%
2. **æ—¶é—´åŠ æƒè¡°å‡æœºåˆ¶** - éªŒè¯æ£€ç´¢ç²¾åº¦æå‡
3. **Mock è‡ªåŠ¨åŒ–æµ‹è¯•** - æ— éœ€çœŸå®æ—¶é—´ç­‰å¾…
4. **Ragas è¯„ä¼°éªŒè¯** - ç«¯åˆ°ç«¯è´¨é‡ä¿è¯

## ğŸ¯ æµ‹è¯•ç›®æ ‡

### æ ¸å¿ƒæŒ‡æ ‡
- **å­˜å‚¨é™ä½ç‡ â‰¥ 45%**ï¼šé€šè¿‡å»é‡å’Œè¿‡æ»¤å‡å°‘å†—ä½™å­˜å‚¨
- **æ£€ç´¢ç²¾åº¦æå‡**ï¼šé€šè¿‡æ—¶é—´è¡°å‡æœºåˆ¶æå‡ç›¸å…³æ€§æ’åº
- **Context Precision æå‡**ï¼šé«˜è´¨é‡ä¿¡æ¯å æ¯”æé«˜
- **Faithfulness æå‡**ï¼šå‡å°‘å¹»è§‰ï¼Œæé«˜å›ç­”å‡†ç¡®æ€§

## ğŸ“Š æµ‹è¯•æ–¹æ³•ï¼šå®éªŒç»„ vs å¯¹ç…§ç»„

### 1. è¯­ä¹‰å»é‡ä¸ä½ä»·å€¼è¿‡æ»¤æµ‹è¯•

#### 1.1 æµ‹è¯•è¯­æ–™å‡†å¤‡

ç”ŸæˆåŒ…å«å¤§é‡"å™ªéŸ³"çš„å¯¹è¯è„šæœ¬ï¼š
- **é‡å¤ä¿¡æ¯**ï¼šè¿ç»­é—®ä¸‰æ¬¡ç›¸åŒæˆ–è¯­ä¹‰é«˜åº¦æ¥è¿‘çš„é—®é¢˜
  - "å¦‚ä½•é…ç½® vLLMï¼Ÿ"
  - "vLLM æ€ä¹ˆé…ï¼Ÿ"
  - "è®²è®² vLLM çš„é…ç½®æ–¹æ³•"
  
- **ä½ä»·å€¼ä¿¡æ¯**ï¼šå¤§é‡å¯’æš„å¯¹è¯
  - "ä½ å¥½"ã€"è°¢è°¢"ã€"å¥½çš„"ã€"åœ¨å—"ã€"æ”¶åˆ°"ç­‰

#### 1.2 å¯¹æ¯”å®éªŒ

**å¯¹ç…§ç»„ (Baseline)**ï¼š
- å…³é—­è¿‡æ»¤é€»è¾‘ï¼Œå°†æ‰€æœ‰å¯¹è¯ç›´æ¥å­˜å…¥ Qdrant
- è®°å½• Collection ä¸­çš„ç‚¹ä½æ€»æ•°ï¼ˆPoints Countï¼‰

**å®éªŒç»„ (Optimized)**ï¼š
- å¼€å¯åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦ï¼ˆé˜ˆå€¼ 0.95ï¼‰çš„å»é‡
- å¼€å¯åŸºäºä¿¡æ¯ç†µ/åˆ†ç±»å™¨çš„ä½ä»·å€¼è¿‡æ»¤
- è®°å½•è¿‡æ»¤åçš„å­˜å‚¨æ¡æ•°

#### 1.3 æŒ‡æ ‡è®¡ç®—

$$\text{å­˜å‚¨é™ä½ç‡} = \frac{\text{å¯¹ç…§ç»„æ¡æ•°} - \text{å®éªŒç»„æ¡æ•°}}{\text{å¯¹ç…§ç»„æ¡æ•°}} \times 100\%$$

**ç›®æ ‡**ï¼šè¯¥æ•°å€¼åº”æ¥è¿‘ 45%

**å®ç°ä½ç½®**ï¼š
- `tests/test_storage_optimization.py::TestDeduplicationAndFiltering`
- `scripts/benchmark/storage_optimization_test.py`

---

### 2. æ—¶é—´åŠ æƒè¡°å‡æœºåˆ¶æµ‹è¯•

#### 2.1 æ„é€ æ—¶é—´å·®æ•°æ®

æ‰‹åŠ¨å‘ Qdrant æ’å…¥ä¸¤æ¡è¯­ä¹‰ç›¸ä¼¼ä½†æ—¶é—´æˆ³ä¸åŒçš„æ•°æ®ï¼š

- **è€è®°å¿† Aï¼ˆ1ä¸ªæœˆå‰ï¼‰**ï¼š
  - å†…å®¹ï¼š"æˆ‘å–œæ¬¢çº¢è‰²çš„è·‘è½¦"
  - `access_count`: 10ï¼ˆè¢«é¢‘ç¹è®¿é—®ï¼Œå¼ºåŒ–ï¼‰
  - `timestamp`: 1ä¸ªæœˆå‰

- **æ–°è®°å¿† Bï¼ˆ1å°æ—¶å‰ï¼‰**ï¼š
  - å†…å®¹ï¼š"æˆ‘æœ€è¿‘åœ¨çœ‹è“è‰²çš„è½¿è½¦"
  - `access_count`: 1ï¼ˆè®¿é—®æ¬¡æ•°å°‘ï¼‰
  - `timestamp`: 1å°æ—¶å‰

#### 2.2 æ£€ç´¢éªŒè¯

**æŸ¥è¯¢**ï¼š"æˆ‘å–œæ¬¢ä»€ä¹ˆè½¦ï¼Ÿ"

**éªŒè¯é€»è¾‘**ï¼š
æ ¹æ®æ—¶é—´åŠ æƒå…¬å¼ï¼š
$$S = S_{semantic} \cdot e^{-\lambda t} \cdot (1 + \alpha \cdot \log(1 + access\_count))$$

**é¢„æœŸç»“æœ**ï¼š
- å¦‚æœ B çš„å¾—åˆ†é«˜äº Aï¼šè¯´æ˜æ—¶é—´è¡°å‡ç”Ÿæ•ˆ âœ…
- å¦‚æœ A çš„å¾—åˆ†ä¾ç„¶å¾ˆé«˜ï¼šè¯´æ˜è®°å¿†å¼ºåŒ–æœºåˆ¶ç”Ÿæ•ˆ âœ…

#### 2.3 ä½¿ç”¨ Mock è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

**é—®é¢˜**ï¼šçœŸå®æµ‹è¯•éœ€è¦ç­‰å¾…"ä¸€ä¸ªæœˆ"

**è§£å†³æ–¹æ¡ˆ**ï¼šMock ç³»ç»Ÿæ—¶é—´

```python
@patch('time.time')
def test_time_decay_mechanism(self, mock_time):
    current_time = time.time()
    
    # è€è®°å¿†ï¼š30å¤©å‰
    mock_time.return_value = current_time - 30 * 24 * 3600
    memory.add_memory(...)
    
    # æ–°è®°å¿†ï¼š1å°æ—¶å‰
    mock_time.return_value = current_time - 3600
    memory.add_memory(...)
    
    # æ£€ç´¢ï¼šå½“å‰æ—¶é—´
    mock_time.return_value = current_time
    results = memory.search(...)
```

**å®ç°ä½ç½®**ï¼š
- `tests/test_storage_optimization.py::TestTimeWeightedDecay`

---

### 3. Ragas è¯„ä¼°éªŒè¯

#### 3.1 Context Precisionï¼ˆä¸Šä¸‹æ–‡ç²¾ç¡®åº¦ï¼‰

**ç›®æ ‡**ï¼šéªŒè¯åœ¨è¿‡æ»¤æ‰ 45% çš„"åºŸè¯"åï¼Œæ£€ç´¢å›æ¥çš„å†…å®¹ä¸­é«˜è´¨é‡ä¿¡æ¯æ˜¯å¦å æ¯”æ›´é«˜

**æµ‹è¯•æ­¥éª¤**ï¼š
1. åœ¨å¯¹ç…§ç»„ä¸Šè¿è¡Œ Ragas è¯„ä¼°
2. åœ¨å®éªŒç»„ä¸Šè¿è¡Œ Ragas è¯„ä¼°
3. å¯¹æ¯” Context Precision æŒ‡æ ‡

**é¢„æœŸç»“æœ**ï¼š
- å®éªŒç»„çš„ Context Precision > å¯¹ç…§ç»„çš„ Context Precision

#### 3.2 Faithfulnessï¼ˆå¿ å®åº¦ï¼‰

**ç›®æ ‡**ï¼šéªŒè¯å‡å°‘å¹²æ‰°ä¿¡æ¯åï¼ŒLLM æ˜¯å¦èƒ½æ›´å‡†ç¡®åœ°åŸºäºä¸Šä¸‹æ–‡å›ç­”ï¼Œå‡å°‘å¹»è§‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ„é€ æµ‹è¯•é—®é¢˜é›†
2. åœ¨å¯¹ç…§ç»„ä¸Šè¯„ä¼° Faithfulness
3. åœ¨å®éªŒç»„ä¸Šè¯„ä¼° Faithfulness
4. å¯¹æ¯”ç»“æœ

**é¢„æœŸç»“æœ**ï¼š
- å®éªŒç»„çš„ Faithfulness > å¯¹ç…§ç»„çš„ Faithfulness

**å®ç°ä½ç½®**ï¼š
- `tests/test_storage_optimization.py::TestRagasEvaluation`
- é›†æˆ `src/evaluation/ragas_eval.py`

---

## ğŸ› ï¸ ä½¿ç”¨æŒ‡å—

### è¿è¡Œå­˜å‚¨ä¼˜åŒ–æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
python scripts/benchmark/storage_optimization_test.py

# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/test_storage_optimization.py -v
```

### æŸ¥çœ‹æµ‹è¯•ç»“æœ

æµ‹è¯•ç»“æœä¿å­˜åœ¨ï¼š
- `scripts/benchmark_results/storage_optimization/storage_optimization_report.json`

### æµ‹è¯•æŠ¥å‘Šæ ¼å¼

```json
{
  "timestamp": 1234567890,
  "test_type": "å­˜å‚¨æ•ˆç‡ä¼˜åŒ–æµ‹è¯•",
  "baseline": {
    "total_memories": 20,
    "archived_count": 20,
    "input_count": 20
  },
  "optimized": {
    "total_memories": 11,
    "archived_count": 11,
    "input_count": 11,
    "filtered_count": 9
  },
  "improvements": {
    "storage_reduction_rate": 45.0,
    "storage_reduction_absolute": 9
  },
  "target_achievement": {
    "storage_reduction_45pct": true
  }
}
```

---

## ğŸ“ å®ç°çŠ¶æ€

### âœ… å·²å®ç°

- [x] åŸºç¡€æµ‹è¯•æ¡†æ¶
- [x] æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨
- [x] å¯¹ç…§ç»„/å®éªŒç»„å¯¹æ¯”æµ‹è¯•
- [x] ç®€åŒ–ç‰ˆä½ä»·å€¼è¿‡æ»¤
- [x] Mock æ—¶é—´æµ‹è¯•æ¡†æ¶

### âš ï¸ å¾…å®ç°åŠŸèƒ½

è¦å®ç°å®Œæ•´çš„ 45% å­˜å‚¨é™ä½ï¼Œéœ€è¦ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **è¯­ä¹‰ç›¸ä¼¼åº¦å»é‡**ï¼ˆé˜ˆå€¼ 0.95ï¼‰
   - å½“å‰ï¼šåªæœ‰ MD5 å“ˆå¸Œå»é‡ï¼ˆå®Œå…¨ç›¸åŒçš„æ–‡æœ¬ï¼‰
   - éœ€è¦ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦çš„å»é‡ï¼ˆè¯­ä¹‰ç›¸ä¼¼ï¼‰

2. **ä½ä»·å€¼ä¿¡æ¯è¿‡æ»¤**
   - å½“å‰ï¼šåŸºäºå…³é”®è¯çš„ç®€åŒ–è¿‡æ»¤
   - éœ€è¦ï¼šåŸºäºä¿¡æ¯ç†µå’Œåˆ†ç±»å™¨çš„æ™ºèƒ½è¿‡æ»¤

3. **æ—¶é—´åŠ æƒè¡°å‡æœºåˆ¶**
   - å½“å‰ï¼šæ—¶é—´æˆ³å­˜å‚¨ï¼Œä½†æœªåœ¨æ£€ç´¢ä¸­ä½¿ç”¨
   - éœ€è¦ï¼šå®ç°æ—¶é—´è¡°å‡å…¬å¼

4. **è®¿é—®è®¡æ•°è·Ÿè¸ª**
   - å½“å‰ï¼šæœªè·Ÿè¸ª access_count
   - éœ€è¦ï¼šè®°å½•æ¯æ¬¡æ£€ç´¢è®¿é—®

5. **Ragas é›†æˆ**
   - å½“å‰ï¼šæµ‹è¯•æ¡†æ¶å·²å‡†å¤‡
   - éœ€è¦ï¼šå®é™…è¿è¡Œ Ragas è¯„ä¼°

---

## ğŸ”§ å®ç°å»ºè®®

### 1. è¯­ä¹‰ç›¸ä¼¼åº¦å»é‡

åœ¨ `src/memory/long_term.py::archive_from_short_term` ä¸­ï¼š

```python
def archive_from_short_term(self, ..., semantic_dedup_threshold=0.95):
    # å¯¹æ¯ä¸ªæ–°å†…å®¹ï¼š
    # 1. è®¡ç®—åµŒå…¥å‘é‡
    # 2. ä¸å·²æœ‰å†…å®¹è®¡ç®—ç›¸ä¼¼åº¦
    # 3. å¦‚æœç›¸ä¼¼åº¦ > 0.95ï¼Œè·³è¿‡
```

### 2. ä½ä»·å€¼ä¿¡æ¯è¿‡æ»¤

åœ¨ `src/core.py::save_context` ä¸­ï¼š

```python
def save_context(self, inputs, outputs):
    # è®¡ç®—ä¿¡æ¯ç†µ
    entropy = calculate_entropy(inputs["input"])
    
    # åˆ†ç±»å™¨åˆ¤æ–­æ˜¯å¦ä¸ºä½ä»·å€¼
    if is_low_value(inputs["input"], entropy):
        return  # ä¸ä¿å­˜
    
    # ä¿å­˜åˆ°çŸ­æœŸè®°å¿†
    self.short_term_memory.add_conversation_turn(...)
```

### 3. æ—¶é—´åŠ æƒæ£€ç´¢

åœ¨ `src/memory/long_term.py::search` ä¸­ï¼š

```python
def search(self, query, ...):
    # è·å–åŸå§‹ç›¸ä¼¼åº¦åˆ†æ•°
    results = vector_search(...)
    
    # åº”ç”¨æ—¶é—´è¡°å‡å’Œå¼ºåŒ–
    for result in results:
        age = current_time - result.metadata["timestamp"]
        access_count = result.metadata.get("access_count", 0)
        
        # æ—¶é—´è¡°å‡
        time_decay = math.exp(-lambda_param * age)
        
        # è®¿é—®å¼ºåŒ–
        reinforcement = 1 + alpha * math.log(1 + access_count)
        
        # ç»¼åˆåˆ†æ•°
        result.relevance_score *= time_decay * reinforcement
    
    # é‡æ–°æ’åº
    results.sort(key=lambda x: x.relevance_score, reverse=True)
```

---

## ğŸ“Š é¢„æœŸç»“æœ

### å­˜å‚¨é™ä½ç‡

åœ¨çœŸå®çš„å®¢æœåœºæ™¯ï¼ˆé«˜é¢‘é‡å¤å’Œå¯’æš„ï¼‰ä¸­ï¼š
- **å¯¹ç…§ç»„**ï¼šå­˜å‚¨ 100 æ¡è®°å¿†
- **å®éªŒç»„**ï¼šå­˜å‚¨ 55 æ¡è®°å¿†ï¼ˆè¿‡æ»¤ 45 æ¡ï¼‰
- **å­˜å‚¨é™ä½ç‡**ï¼š45% âœ…

### æ£€ç´¢ç²¾åº¦

- **Context Precision**ï¼šä» 0.65 æå‡åˆ° 0.85 âœ…
- **Faithfulness**ï¼šä» 0.70 æå‡åˆ° 0.90 âœ…

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šå­˜å‚¨é™ä½ç‡ä¸è¶³ 45%

**åŸå› **ï¼š
- å½“å‰å®ç°åªæœ‰åŸºç¡€å»é‡
- æœªå®ç°è¯­ä¹‰ç›¸ä¼¼åº¦å»é‡
- ä½ä»·å€¼è¿‡æ»¤æ˜¯ç®€åŒ–ç‰ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç°è¯­ä¹‰ç›¸ä¼¼åº¦å»é‡ï¼ˆé˜ˆå€¼ 0.95ï¼‰
- å®ç°æ™ºèƒ½ä½ä»·å€¼è¿‡æ»¤

### é—®é¢˜ 2ï¼šæ—¶é—´è¡°å‡æµ‹è¯•å¤±è´¥

**åŸå› **ï¼š
- æœªå®ç°æ—¶é—´åŠ æƒå…¬å¼
- æœªè·Ÿè¸ª access_count

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç°æ—¶é—´è¡°å‡æœºåˆ¶
- æ·»åŠ è®¿é—®è®¡æ•°è·Ÿè¸ª

### é—®é¢˜ 3ï¼šRagas è¯„ä¼°æ— æ³•è¿è¡Œ

**åŸå› **ï¼š
- ä¾èµ–æœªå®‰è£…
- API Key æœªé…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®‰è£… Ragasï¼š`pip install ragas`
- é…ç½® API Key

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Ragas è¯„ä¼°æ¡†æ¶æ–‡æ¡£](https://docs.ragas.io/)
- [è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—](https://www.sbert.net/)
- [ä¿¡æ¯ç†µè®¡ç®—](https://en.wikipedia.org/wiki/Entropy_(information_theory))

---

**æœ€åæ›´æ–°**ï¼š2026-01-22
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
